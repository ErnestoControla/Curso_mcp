# Sistema de An√°lisis de Base de Datos con IA (MCP + Ollama + MariaDB)

Este sistema combina un servidor MCP con Ollama para crear un asistente de an√°lisis de base de datos impulsado por IA. Permite hacer consultas en lenguaje natural que se traducen autom√°ticamente en an√°lisis de datos y m√©tricas.

## Configuraci√≥n

### Credenciales de Base de Datos
- **Host:** 172.16.1.29
- **Usuario:** controla
- **Contrase√±a:** controla

### Requisitos Previos

1. **Ollama** ejecut√°ndose con el modelo `llama3.1:8b`
2. **MariaDB** accesible en la red
3. **Python 3.8+**

### Instalaci√≥n Autom√°tica

```bash
python setup.py
```

Este script:
- üì¶ Instala todas las dependencias
- üîç Prueba la conexi√≥n a MariaDB
- ü¶ô Verifica la conexi√≥n con Ollama
- ‚öôÔ∏è Crea archivo de configuraci√≥n

### Instalaci√≥n Manual

```bash
pip install -r requirements.txt
```

### Ejecutar el Sistema

```bash
# Modo interactivo con IA
python client.py

# Solo servidor MCP (sin IA)
python server.py
```

## ü§ñ Funcionalidades del Asistente IA

### An√°lisis en Lenguaje Natural
El sistema acepta preguntas en espa√±ol y las convierte autom√°ticamente en an√°lisis de datos:

**Ejemplos de preguntas:**
- "¬øQu√© bases de datos hay disponibles?"
- "Analiza la tabla usuarios en la base de datos tienda"
- "Compara las tablas productos y categor√≠as"
- "¬øCu√°les son las m√©tricas de la tabla ventas?"
- "Mu√©strame los 10 productos m√°s vendidos"
- "¬øCu√°l es la distribuci√≥n de edades en la tabla clientes?"

### Capacidades de An√°lisis
- üìä **M√©tricas autom√°ticas**: Estad√≠sticas, conteos, distribuciones
- üîç **An√°lisis comparativo**: Diferencias entre tablas y estructuras
- üìà **Insights inteligentes**: Patrones y tendencias detectados por IA
- üìã **Reportes detallados**: An√°lisis completos con recomendaciones

## üõ†Ô∏è Herramientas MCP Disponibles

### Herramientas de Conexi√≥n

### 1. `test_connection()`
Prueba la conexi√≥n a la base de datos MariaDB.

**Ejemplo de uso:**
```json
{
  "success": true,
  "connected": true,
  "server_version": "10.6.12-MariaDB",
  "server_time": "2024-01-15T10:30:00",
  "host": "172.16.1.29",
  "user": "controla"
}
```

### 2. `list_databases()`
Lista todas las bases de datos disponibles en el servidor.

**Retorna:**
- Lista de nombres de bases de datos
- Conteo total
- Timestamp

### 3. `list_tables(database: str)`
Lista todas las tablas en una base de datos espec√≠fica.

**Par√°metros:**
- `database`: Nombre de la base de datos

### 4. `describe_table(database: str, table: str)`
Obtiene la estructura completa de una tabla.

**Par√°metros:**
- `database`: Nombre de la base de datos
- `table`: Nombre de la tabla

**Retorna:**
- Informaci√≥n de columnas (tipo, null, clave, default, extra)
- N√∫mero de columnas

### 5. `execute_query(database: str, query: str, limit: int = 100)`
Ejecuta consultas SELECT de forma segura.

**Par√°metros:**
- `database`: Nombre de la base de datos
- `query`: Consulta SQL (solo SELECT)
- `limit`: L√≠mite de resultados (por defecto 100)

**Caracter√≠sticas de seguridad:**
- Solo permite consultas SELECT
- Aplica l√≠mite autom√°tico si no se especifica
- Convierte fechas/tiempo a formato ISO

### 6. `insert_data(database: str, table: str, data: Dict[str, Any])`
Inserta un nuevo registro en una tabla.

**Par√°metros:**
- `database`: Nombre de la base de datos
- `table`: Nombre de la tabla
- `data`: Diccionario con los datos a insertar

**Ejemplo:**
```python
data = {
    "nombre": "Juan P√©rez",
    "email": "juan@ejemplo.com",
    "edad": 30
}
```

### 7. `update_data(database: str, table: str, data: Dict[str, Any], where_clause: str)`
Actualiza registros existentes en una tabla.

**Par√°metros:**
- `database`: Nombre de la base de datos
- `table`: Nombre de la tabla
- `data`: Diccionario con los nuevos valores
- `where_clause`: Condici√≥n WHERE (sin la palabra WHERE)

**Ejemplo:**
```python
data = {"email": "nuevo@ejemplo.com"}
where_clause = "id = 123"
```

### 8. `delete_data(database: str, table: str, where_clause: str)`
Elimina registros de una tabla.

**Par√°metros:**
- `database`: Nombre de la base de datos
- `table`: Nombre de la tabla
- `where_clause`: Condici√≥n WHERE (sin la palabra WHERE)

### 6. `get_table_metrics(database: str, table: str)`
Obtiene m√©tricas completas de una tabla incluyendo estad√≠sticas num√©ricas.

**Retorna:**
- N√∫mero de registros y estructura
- Estad√≠sticas de columnas num√©ricas (min, max, avg, distinct)
- Informaci√≥n de √≠ndices y almacenamiento

### 7. `get_database_overview(database: str)`
Obtiene un resumen completo de una base de datos.

**Retorna:**
- Total de tablas y registros
- Tama√±o total de la base de datos
- Informaci√≥n detallada de cada tabla

### 8. `compare_tables(database: str, table1: str, table2: str)`
Compara dos tablas en t√©rminos de estructura y m√©tricas.

**Retorna:**
- Columnas comunes y diferentes
- Diferencias en tama√±o y registros
- Porcentaje de similaridad estructural

### 9. `analyze_data_distribution(database: str, table: str, column: str)`
Analiza la distribuci√≥n de datos en una columna espec√≠fica.

**Retorna:**
- Estad√≠sticas b√°sicas (conteos, nulos, √∫nicos)
- Top valores m√°s frecuentes
- Estad√≠sticas num√©ricas (si aplica)

## Recursos Disponibles

### 1. `mariadb://connection_info`
Informaci√≥n de configuraci√≥n de conexi√≥n (sin mostrar contrase√±a).

### 2. `mariadb://status`
Estado actual del servidor MariaDB incluyendo:
- Tiempo de actividad
- Conexiones activas
- Total de consultas

## Caracter√≠sticas de Seguridad

1. **Solo consultas SELECT**: La herramienta `execute_query` solo permite consultas SELECT para evitar modificaciones accidentales.

2. **L√≠mites autom√°ticos**: Se aplican l√≠mites autom√°ticos a las consultas para evitar resultados excesivamente grandes.

3. **Manejo de errores**: Todas las herramientas incluyen manejo robusto de errores.

4. **Logging**: Se registra informaci√≥n importante para debugging.

5. **Sanitizaci√≥n**: Los par√°metros se pasan de forma segura usando placeholders.

## üöÄ Configuraci√≥n de Ollama

### Instalar y Configurar Ollama

```bash
# Instalar Ollama (si no lo tienes)
curl -fsSL https://ollama.ai/install.sh | sh

# Descargar el modelo
ollama pull llama3.1:8b

# Ejecutar Ollama (permitir conexiones externas)
OLLAMA_HOST=0.0.0.0 ollama serve
```

### Verificar que Ollama est√© ejecut√°ndose
```bash
curl http://localhost:11434/api/tags
```

## üí¨ Ejemplos de Conversaci√≥n con IA

### Ejemplo 1: Exploraci√≥n Inicial
```
Usuario: ¬øQu√© bases de datos hay disponibles?

Asistente: üîß Ejecutando: list_databases()
üìä Resultado: {
  "success": true,
  "databases": ["tienda", "usuarios", "logs", "analytics"],
  "count": 4
}

ü§ñ An√°lisis: Encontr√© 4 bases de datos disponibles:
- tienda: Probablemente contiene datos de e-commerce
- usuarios: Sistema de gesti√≥n de usuarios
- logs: Registros del sistema
- analytics: Datos para an√°lisis y reportes

¬øTe gustar√≠a explorar alguna en particular?
```

### Ejemplo 2: An√°lisis de Tabla
```
Usuario: Analiza la tabla productos en la base tienda

Asistente: üîß Ejecutando: get_table_metrics(database="tienda", table="productos")
üìä Resultado: {
  "success": true,
  "row_count": 1250,
  "numeric_statistics": {
    "precio": {"min": 9.99, "max": 1299.99, "avg": 145.67},
    "stock": {"min": 0, "max": 500, "avg": 45.2}
  }
}

ü§ñ An√°lisis: La tabla productos contiene 1,250 productos con:
‚Ä¢ Precios desde $9.99 hasta $1,299.99 (promedio: $145.67)
‚Ä¢ Stock desde 0 hasta 500 unidades (promedio: 45.2)
‚Ä¢ Hay productos sin stock (valor m√≠nimo 0)

Recomendaciones:
- Revisar productos con stock 0
- El rango de precios es amplio, considera categorizaci√≥n
```

## üîß Flujo de Trabajo T√©cnico (MCP)

Para desarrollo o uso directo de las herramientas MCP:

1. **Probar conexi√≥n:**
   ```python
   test_connection()
   ```

2. **An√°lisis completo de base de datos:**
   ```python
   get_database_overview("mi_base_datos")
   ```

3. **Comparar estructuras:**
   ```python
   compare_tables("mi_base_datos", "usuarios", "clientes")
   ```

4. **An√°lisis de distribuci√≥n:**
   ```python
   analyze_data_distribution("mi_base_datos", "ventas", "precio")
   ```

## Notas Importantes

- **Codificaci√≥n**: Se usa UTF8MB4 para soporte completo de Unicode
- **Autocommit**: Est√° habilitado por defecto
- **Conexiones**: Se abren y cierran autom√°ticamente para cada operaci√≥n
- **Timestamps**: Todos los resultados incluyen timestamps ISO 8601

## üîß Troubleshooting

### Error de Conexi√≥n a MariaDB
Si no puedes conectarte a la base de datos:
1. Verifica que la IP 172.16.1.29 sea accesible
2. Confirma que el usuario "controla" tenga permisos
3. Aseg√∫rate de que el puerto 3306 est√© abierto
4. Verifica que PyMySQL est√© instalado correctamente

### Error de Conexi√≥n a Ollama
Si el cliente no puede conectarse a Ollama:
1. **Verificar que Ollama est√© ejecut√°ndose:**
   ```bash
   curl http://localhost:11434/api/tags
   ```

2. **Ollama en red local:**
   ```bash
   # Ejecutar Ollama permitiendo conexiones externas
   OLLAMA_HOST=0.0.0.0 ollama serve
   ```

3. **Verificar modelo disponible:**
   ```bash
   ollama list
   # Si no est√°: ollama pull llama3.1:8b
   ```

4. **Firewall/Puertos:**
   - Puerto 11434 debe estar abierto
   - Verificar configuraci√≥n de firewall

### Error de Permisos en MariaDB
El usuario "controla" necesita estos permisos:
- **SELECT**: Para consultas y an√°lisis
- **SHOW DATABASES**: Para listar bases de datos  
- **SHOW TABLES**: Para explorar estructuras

### Problemas de Rendimiento
Si las consultas son lentas:
1. Limita los resultados usando el par√°metro `limit`
2. Considera usar √≠ndices en las columnas consultadas
3. El sistema aplica l√≠mites autom√°ticos para proteger el rendimiento

### Errores Comunes

**Error: "Modelo no disponible"**
```bash
ollama pull llama3.1:8b
```

**Error: "Connection refused" (Ollama)**
```bash
# Verificar que Ollama est√© ejecut√°ndose
ps aux | grep ollama
# Si no est√°: ollama serve
```

**Error: "Access denied" (MariaDB)**
```sql
-- Verificar permisos del usuario
SHOW GRANTS FOR 'controla'@'%';
```

## üì¶ Dependencias

### Librer√≠as Python
- `fastmcp`: Framework MCP para herramientas de base de datos
- `pymysql`: Conector MySQL/MariaDB
- `requests`: Cliente HTTP para comunicaci√≥n con Ollama
- `typing-extensions`: Extensiones de tipado para Python

### Servicios Externos
- **Ollama**: Servidor de LLM local (llama3.1:8b)
- **MariaDB**: Base de datos (172.16.1.29)

### Instalaci√≥n Completa
```bash
# Opci√≥n 1: Instalaci√≥n autom√°tica
python setup.py

# Opci√≥n 2: Instalaci√≥n manual
pip install -r requirements.txt
```

## üéØ Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP/REST    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ                 ‚îÇ
‚îÇ     Ollama      ‚îÇ                 ‚îÇ   Cliente MCP   ‚îÇ
‚îÇ   (llama3.1)    ‚îÇ                 ‚îÇ   (client.py)   ‚îÇ
‚îÇ                 ‚îÇ                 ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                             ‚îÇ MCP Protocol
                                             ‚ñº
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ                 ‚îÇ
                                    ‚îÇ  Servidor MCP   ‚îÇ
                                    ‚îÇ   (server.py)   ‚îÇ
                                    ‚îÇ                 ‚îÇ
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                             ‚îÇ MySQL Protocol
                                             ‚ñº
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ                 ‚îÇ
                                    ‚îÇ    MariaDB      ‚îÇ
                                    ‚îÇ  172.16.1.29    ‚îÇ
                                    ‚îÇ                 ‚îÇ
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìà Pr√≥ximas Funcionalidades

- üìä Generaci√≥n autom√°tica de gr√°ficos
- üìù Exportaci√≥n de reportes en PDF/Excel
- üîÑ Monitoreo en tiempo real
- üéØ Alertas inteligentes basadas en patrones
- üîó Integraci√≥n con m√°s LLMs (GPT, Claude, etc.)

## ü§ù Contribuir

¬øQuieres mejorar el sistema? ¬°Las contribuciones son bienvenidas!

1. Fork del repositorio
2. Crear rama de feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit de cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Crear Pull Request 